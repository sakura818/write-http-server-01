package jp.co.topgate.sugawara.web;


import java.io.*;
import java.net.ServerSocket;
import java.net.Socket;
import java.util.HashMap;
import java.util.Map;

/*
 * HttpServer class
 * connectionを管理する
 *  This Java source file was generated by the Gradle 'init' task.
 *
 * @author sakura818
 *
 */
public class HttpServer {

    private Socket socket;
    int PORT = 8080;
    private static final String FILE_DIR = "src/main/resources/";

    /**
     * コンストラクタ
     */

    public HttpServer(Socket socket, int PORT){
        this.PORT = PORT;
        this.socket = socket;
    }

    /**
     * リクエスト
     */

    public void connection() {
        try {
            System.out.println("request...");
            InputStream is = this.socket.getInputStream();
            OutputStream os = this.socket.getOutputStream();

            HttpRequest httpRequest = new HttpRequest();
            System.out.println("request incoming");
            System.out.println("---------------------------------------");

            File file = new File(FILE_DIR, httpRequest.requestUriDecodeAndPath());
            ResponseHandler responseHandler = new ResponseHandler();

            int statusCode = distinguishStatusCode(httpRequest, file);
            switch (httpRequest.getMethod()) {
                case "GET":
                    responseHandler.handlerGet(statusCode, file, os);
                    break;
                case "HEAD":
                    responseHandler.handleError(statusCode, os);
                    break;
            }
        } catch (IOException e) {
            throw new RuntimeException(e);
        } finally {
            try {
                if (socket != null) {
                    this.socket.close();
                }
            } catch (IOException e) {
                throw new RuntimeException(e);
            }
            System.out.println("正常にコネクションできないエラーが発生しました");
        }
    }


    /**
     * 適切なステータスコードを返す
     */

    public int distinguishStatusCode(HttpRequest httpRequest, File file) throws IOException {
        if (httpRequest.getMethod() == null) {
            return 400;
        }
        if (!file.exists()) {
            return 404;
        }
        return 200;
    }

    /**
     * statuscodeに対応するreason-phraseの一覧表
     */

    public final Map<Integer, String> STATUSCODE = new HashMap<Integer, String>() {
        {
            put(200, "OK");
            put(400, "Bad Request");
            put(404, "Not Found");
        }
    };
}



